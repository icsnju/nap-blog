<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Spring Transaction Manager学习笔记 › NAP - Next Application Platform</title>
  <meta name="author" content="NAP Group">
  
  <meta name="description" content="使用Spring声明式事务处理，是通过结合IoC容器和Spring已有的TransactionProxyFactoryBean来对事务管理进行配置。在TransactionProxyFactoryBean中为事务方法配置传播行为、并发事务隔离级别这些事务处理的属性，从而对声明式事务的处理提供指导。声明式事务处理的实现，大致可以分为以下三个部分：

读取和处理在IoC容器中配置的事务处理属性， 并转为Spring事务处理需要的内部数据结构。
Spring事务处理模块实现的统一的事务处理过程。包含了处理事务配置属性，以及与现场绑定完成事务处理。Spring通过TransactionInfo和TransactionStatus两个数据对象，在事务处理过程中记录和传递相关执行场景。
对于底层的事务操作，Spring委托给具体的事务处理器来完成，即PlatformTransactionManager的具体实现。比如DataSourceTransactionManager和HibernateTransactionManager。">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="Spring Transaction Manager学习笔记"/>
  <meta property="og:site_name" content="NAP - Next Application Platform"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="NAP - Next Application Platform" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  

</head>


<body>
  <header id="header"><div class="meta inner">
  <h1><a href="/">NAP - Next Application Platform</a></h1>
  <h2><a href="/"></a></h2>
  <nav id="main-nav">
    <ul>
      
      <li><a href="/archives">Archives</a></li>
      
    </ul>
    <div class="clearfix"></div>
  </nav>
</div>
<div class="clearfix"></div>
</header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  <div class="post-content">
    <header>
      
  
    <h1 class="title">Spring Transaction Manager学习笔记</h1>
  

      
        <time datetime="2015-11-09T16:00:00.000Z">2015-11-10</time>
      
    </header>
    <div class="entry">
      
        <p>使用Spring声明式事务处理，是通过结合IoC容器和Spring已有的TransactionProxyFactoryBean来对事务管理进行配置。<br>在TransactionProxyFactoryBean中为事务方法配置传播行为、并发事务隔离级别这些事务处理的属性，<br>从而对声明式事务的处理提供指导。<br>声明式事务处理的实现，大致可以分为以下三个部分：</p>
<ul>
<li>读取和处理在IoC容器中配置的事务处理属性， 并转为Spring事务处理需要的内部数据结构。</li>
<li>Spring事务处理模块实现的统一的事务处理过程。包含了处理事务配置属性，以及与现场绑定完成事务处理。Spring通过TransactionInfo和TransactionStatus两个数据对象，在事务处理过程中记录和传递相关执行场景。</li>
<li>对于底层的事务操作，Spring委托给具体的事务处理器来完成，即PlatformTransactionManager的具体实现。比如DataSourceTransactionManager和HibernateTransactionManager。</li>
</ul>
<a id="more"></a>
<hr>
<h2 id="声明式事务处理的基本过程"><a href="#声明式事务处理的基本过程" class="headerlink" title="声明式事务处理的基本过程"></a>声明式事务处理的基本过程</h2><p>使用Spring声明式事务处理，是通过结合IoC容器和Spring已有的TransactionProxyFactoryBean来对事务管理进行配置。<br>在TransactionProxyFactoryBean中为事务方法配置传播行为、并发事务隔离级别这些事务处理的属性，<br>从而对声明式事务的处理提供指导。<br>声明式事务处理的实现，大致可以分为以下三个部分：</p>
<ul>
<li>读取和处理在IoC容器中配置的事务处理属性， 并转为Spring事务处理需要的内部数据结构。</li>
<li>Spring事务处理模块实现的统一的事务处理过程。包含了处理事务配置属性，以及与现场绑定完成事务处理。Spring通过TransactionInfo和TransactionStatus两个数据对象，在事务处理过程中记录和传递相关执行场景。</li>
<li>对于底层的事务操作，Spring委托给具体的事务处理器来完成，即PlatformTransactionManager的具体实现。比如DataSourceTransactionManager和HibernateTransactionManager。</li>
</ul>
<h2 id="事务处理拦截器的配置"><a href="#事务处理拦截器的配置" class="headerlink" title="事务处理拦截器的配置"></a>事务处理拦截器的配置</h2><p>配置工作，包括设置拦截器TransactionInterceptor、通知器DefaultPointcutAdvisor、<br>注入进来的PlatformTransactionManager和事务处理属性TransactionAttribute。<br>这些工作是由IoC的TransactionProxyFactoryBean完成的。它的实现如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">public class TransactionProxyFactoryBean extends AbstractSingletonProxyFactoryBean</div><div class="line">		implements BeanFactoryAware &#123;</div><div class="line">	/**</div><div class="line">	 * 这个拦截器通过AOP发挥作用，通过这个拦截器，Spring封装了事务处理实现</div><div class="line">	 */</div><div class="line">	private final TransactionInterceptor transactionInterceptor = new TransactionInterceptor();</div><div class="line"></div><div class="line">	private Pointcut pointcut;</div><div class="line"></div><div class="line"></div><div class="line">	/**</div><div class="line">	 * Set the default transaction manager. This will perform actual</div><div class="line">	 * transaction management: This class is just a way of invoking it.</div><div class="line">	 * @see TransactionInterceptor#setTransactionManager</div><div class="line">	 */</div><div class="line">	public void setTransactionManager(PlatformTransactionManager transactionManager) &#123;</div><div class="line">		this.transactionInterceptor.setTransactionManager(transactionManager);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	/**</div><div class="line">	 * Creates an advisor for this FactoryBean&apos;s TransactionInterceptor.</div><div class="line">	 * 创建Spring AOP对事务处理的AOP</div><div class="line">	 */</div><div class="line">	@Override</div><div class="line">	protected Object createMainInterceptor() &#123;</div><div class="line">		this.transactionInterceptor.afterPropertiesSet();</div><div class="line">		if (this.pointcut != null) &#123;</div><div class="line">			return new DefaultPointcutAdvisor(this.pointcut, this.transactionInterceptor);</div><div class="line">		&#125;</div><div class="line">		else &#123;</div><div class="line">			// Rely on default pointcut.</div><div class="line">			return new TransactionAttributeSourceAdvisor(this.transactionInterceptor);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>有上面的代码可以知道，TransactionInterceptor在方法<code>createMainInterceptor</code>中被配置为Advisor通知器的一部分。<br>而<code>createMainInterceptor</code>方法在IoC容器完成Bean的注入依赖时，通过<code>initiaizeBean</code>方法被调用，调用过程如下图:<br><img src="/images/createMainInterceptor.png" alt=""></p>
<p>这个<code>afterPropertiesSet</code>方法的功能实现如下所示。从代码中可以看到，在建立TransactionProxyFactoryBean的事务<br>处理拦截器的时候，首先需要对ProxyFactoryBean的目标Bean设置进行检查，如果这个目标Bean的配置是正确的，<br>就会通过创建一个ProxyFactory对象，从而实现AOP的使用。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line">public void afterPropertiesSet() &#123;</div><div class="line">    if (this.target == null) &#123;</div><div class="line">    	throw new IllegalArgumentException(&quot;Property &apos;target&apos; is required&quot;);</div><div class="line">    &#125;</div><div class="line">    if (this.target instanceof String) &#123;</div><div class="line">    	throw new IllegalArgumentException(&quot;&apos;target&apos; needs to be a bean reference, not a bean name as value&quot;);</div><div class="line">    &#125;</div><div class="line">    if (this.proxyClassLoader == null) &#123;</div><div class="line">    	this.proxyClassLoader = ClassUtils.getDefaultClassLoader();</div><div class="line">    &#125;</div><div class="line">    //TransactionFactoryBean使用ProxyFactory完成AOP的基本功能</div><div class="line">    ProxyFactory proxyFactory = new ProxyFactory();</div><div class="line">    </div><div class="line">    if (this.preInterceptors != null) &#123;</div><div class="line">    	for (Object interceptor : this.preInterceptors) &#123;</div><div class="line">    		proxyFactory.addAdvisor(this.advisorAdapterRegistry.wrap(interceptor));</div><div class="line">    	&#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    // Add the main interceptor (typically an Advisor).</div><div class="line">    proxyFactory.addAdvisor(this.advisorAdapterRegistry.wrap(createMainInterceptor()));</div><div class="line">    </div><div class="line">    if (this.postInterceptors != null) &#123;</div><div class="line">    	for (Object interceptor : this.postInterceptors) &#123;</div><div class="line">    		proxyFactory.addAdvisor(this.advisorAdapterRegistry.wrap(interceptor));</div><div class="line">    	&#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    proxyFactory.copyFrom(this);</div><div class="line">    //设置目标源</div><div class="line">    TargetSource targetSource = createTargetSource(this.target);</div><div class="line">    proxyFactory.setTargetSource(targetSource);</div><div class="line">    </div><div class="line">    if (this.proxyInterfaces != null) &#123;</div><div class="line">    	proxyFactory.setInterfaces(this.proxyInterfaces);</div><div class="line">    &#125;</div><div class="line">    else if (!isProxyTargetClass()) &#123;</div><div class="line">    	// Rely on AOP infrastructure to tell us what interfaces to proxy.</div><div class="line">    	proxyFactory.setInterfaces(</div><div class="line">    			ClassUtils.getAllInterfacesForClass(targetSource.getTargetClass(), this.proxyClassLoader));</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    this.proxy = proxyFactory.getProxy(this.proxyClassLoader);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="事务处理拦截器的实现"><a href="#事务处理拦截器的实现" class="headerlink" title="事务处理拦截器的实现"></a>事务处理拦截器的实现</h2><p>对事务方法的拦截是通过<code>invoke</code>方法，它使Proxy代理对象的回调方法。在事务处理拦截器TransactionInterceptor中，<br><code>invoke</code>方法的实现代码如下。可以看到，首先获得调用方法的事务处理配置，之后取得配置的PlatformTransactionManager<br>,由这个事务处理器来实现事务的创建、提交、回滚操作。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line">public Object invoke(final MethodInvocation invocation) throws Throwable &#123;</div><div class="line">	// Work out the target class: may be &#123;@code null&#125;.</div><div class="line">	// The TransactionAttributeSource should be passed the target class</div><div class="line">	// as well as the method, which may be from an interface.</div><div class="line">	Class&lt;?&gt; targetClass = (invocation.getThis() != null ? AopUtils.getTargetClass(invocation.getThis()) : null);</div><div class="line"></div><div class="line">	// Adapt to TransactionAspectSupport&apos;s invokeWithinTransaction...</div><div class="line">	return invokeWithinTransaction(invocation.getMethod(), targetClass, new InvocationCallback() &#123;</div><div class="line">		@Override</div><div class="line">		public Object proceedWithInvocation() throws Throwable &#123;</div><div class="line">			return invocation.proceed();</div><div class="line">		&#125;</div><div class="line">	&#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">protected Object invokeWithinTransaction(Method method, Class&lt;?&gt; targetClass, final InvocationCallback invocation)</div><div class="line">		throws Throwable &#123;</div><div class="line"></div><div class="line">	// If the transaction attribute is null, the method is non-transactional.</div><div class="line">	final TransactionAttribute txAttr = getTransactionAttributeSource().getTransactionAttribute(method, targetClass);</div><div class="line">	final PlatformTransactionManager tm = determineTransactionManager(txAttr);</div><div class="line">	final String joinpointIdentification = methodIdentification(method, targetClass);</div><div class="line">	/**</div><div class="line">	 * 区分不同类型的PlatformTransactionManager, 因为他们的调用方式不同，</div><div class="line">	 * 像DataSourceTransactionManager来说，不是CallbackPreferringPlatformTransactionManager,</div><div class="line">	 * 不需要通过回调的方式来使用。</div><div class="line">	 */</div><div class="line">	if (txAttr == null || !(tm instanceof CallbackPreferringPlatformTransactionManager)) &#123;</div><div class="line">		// Standard transaction demarcation with getTransaction and commit/rollback calls.</div><div class="line">		//TransactionInfo是保存当前事务状态的对象</div><div class="line">		TransactionInfo txInfo = createTransactionIfNecessary(tm, txAttr, joinpointIdentification);</div><div class="line">		Object retVal = null;</div><div class="line">		try &#123;</div><div class="line">			// This is an around advice: Invoke the next interceptor in the chain.</div><div class="line">			// This will normally result in a target object being invoked.</div><div class="line">			retVal = invocation.proceedWithInvocation();</div><div class="line">		&#125;</div><div class="line">		catch (Throwable ex) &#123;</div><div class="line">			// target invocation exception</div><div class="line">			completeTransactionAfterThrowing(txInfo, ex);</div><div class="line">			throw ex;</div><div class="line">		&#125;</div><div class="line">		finally &#123;</div><div class="line">			cleanupTransactionInfo(txInfo);</div><div class="line">		&#125;</div><div class="line">		commitTransactionAfterReturning(txInfo);</div><div class="line">		return retVal;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	else &#123;</div><div class="line">		.....</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>##事务的创建<br>我们注意到TransactionInterceptor拦截器的<code>invoke</code>回调中使用的<code>createTransactionIfNecessary</code>方法，它是事务创建的起点。它的实现代码如下。在<code>createTransactionIfNecessary</code>方法调用中，可以看到两个重要的数据对象TransactionStatus和TransactionInfo的调用，这两个对象持有的<br>数据是事务处理器对事务进行处理的主要依据，对他们的使用贯穿着整个事务处理的过程。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line">protected TransactionInfo createTransactionIfNecessary(</div><div class="line">		PlatformTransactionManager tm, TransactionAttribute txAttr, final String joinpointIdentification) &#123;</div><div class="line"></div><div class="line">	// If no name specified, apply method identification as transaction name.</div><div class="line">	if (txAttr != null &amp;&amp; txAttr.getName() == null) &#123;</div><div class="line">		txAttr = new DelegatingTransactionAttribute(txAttr) &#123;</div><div class="line">			@Override</div><div class="line">			public String getName() &#123;</div><div class="line">				return joinpointIdentification;</div><div class="line">			&#125;</div><div class="line">		&#125;;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	TransactionStatus status = null;</div><div class="line">	if (txAttr != null) &#123;</div><div class="line">		if (tm != null) &#123;</div><div class="line">			/**</div><div class="line">			 * 这里使用我们定义好的事务方法的配置信息。</div><div class="line">			 * 事务创建由事务处理器来完成，同时返回TransactionStatus来记录</div><div class="line">			 * 当前的事务状态，包括已经创建的事务。</div><div class="line">			 */</div><div class="line">			status = tm.getTransaction(txAttr);</div><div class="line">		&#125;</div><div class="line">		else &#123;</div><div class="line">			if (logger.isDebugEnabled()) &#123;</div><div class="line">				logger.debug(&quot;Skipping transactional joinpoint [&quot; + joinpointIdentification +</div><div class="line">						&quot;] because no transaction manager has been configured&quot;);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	//准备TransactionInfo，它封装了事务处理的配置信息以及TransactionStatus</div><div class="line">	return prepareTransactionInfo(tm, txAttr, joinpointIdentification, status);</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">protected TransactionInfo prepareTransactionInfo(PlatformTransactionManager tm,</div><div class="line">		TransactionAttribute txAttr, String joinpointIdentification, TransactionStatus status) &#123;</div><div class="line"></div><div class="line">	TransactionInfo txInfo = new TransactionInfo(tm, txAttr, joinpointIdentification);</div><div class="line">	if (txAttr != null) &#123;</div><div class="line">		// We need a transaction for this method</div><div class="line">		if (logger.isTraceEnabled()) &#123;</div><div class="line">			logger.trace(&quot;Getting transaction for [&quot; + txInfo.getJoinpointIdentification() + &quot;]&quot;);</div><div class="line">		&#125;</div><div class="line">		// The transaction manager will flag an error if an incompatible tx already exists</div><div class="line">		txInfo.newTransactionStatus(status);</div><div class="line">	&#125;</div><div class="line">	else &#123;</div><div class="line">		// The TransactionInfo.hasTransaction() method will return</div><div class="line">		// false. We created it only to preserve the integrity of</div><div class="line">		// the ThreadLocal stack maintained in this class.</div><div class="line">		if (logger.isTraceEnabled())</div><div class="line">			logger.trace(&quot;Don&apos;t need to create transaction for [&quot; + joinpointIdentification +</div><div class="line">					&quot;]: This method isn&apos;t transactional.&quot;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	// We always bind the TransactionInfo to the thread, even if we didn&apos;t create</div><div class="line">	// a new transaction here. This guarantees that the TransactionInfo stack</div><div class="line">	// will be managed correctly even if no transaction was created by this aspect.</div><div class="line">	txInfo.bindToThread();</div><div class="line">	return txInfo;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在以上的处理过程完成以后，可以看到具体的事务创建就交给事务处理器来完成了。下面看事务处理器中去了解<br>一下更底层的事务创建过程，它被上述代码的<code>tm.getTransaction(txAttr)</code>调用出发，生成一个TransactionStatus对象，<br>封装了底层事务对象的创建。在AbstractPlatformTransactionManager中，提供了创建事务的模板，代码如下所示。<br>AbstractPlatformTransactionManager会根据事务属性配置和当前线程绑定的事务信息，对事务是否需要创建、怎样创建<br>进行一些通用的处理，然后把事务创建的底层工作交给具体的事务处理器完成(如DataSourceTransactionManagera)。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div></pre></td><td class="code"><pre><div class="line">public final TransactionStatus getTransaction(TransactionDefinition definition) throws TransactionException &#123;</div><div class="line">	/**</div><div class="line">	 * 这个doGetTransaction是抽象函数，Transaction对象的取得由具体的事务处理器实现。</div><div class="line">	 * 比如DataSourceTransactionManager</div><div class="line">	 */</div><div class="line">	Object transaction = doGetTransaction();</div><div class="line"></div><div class="line">	// Cache debug flag to avoid repeated checks.</div><div class="line">	boolean debugEnabled = logger.isDebugEnabled();</div><div class="line"></div><div class="line">	if (definition == null) &#123;</div><div class="line">		/*</div><div class="line">		 * 使用默认的DefaultTransactionDefinition：</div><div class="line">		 * propagationBehavior=PROPAGATION_REQUIRED</div><div class="line">		 * isolationLevel=ISOLATION_DEFAULT;</div><div class="line">		 * timeout=TIMEOUT_DEFAULT;</div><div class="line">		 * readOnly=false;</div><div class="line">		 */</div><div class="line">		// Use defaults if no transaction definition given.</div><div class="line">		definition = new DefaultTransactionDefinition();</div><div class="line">	&#125;</div><div class="line">	//如果当前线程存在事务，需要根据事务传播属性生成事务</div><div class="line">	if (isExistingTransaction(transaction)) &#123;</div><div class="line">		// Existing transaction found -&gt; check propagation behavior to find out how to behave.</div><div class="line">		return handleExistingTransaction(definition, transaction, debugEnabled);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	// Check definition settings for new transaction.</div><div class="line">	if (definition.getTimeout() &lt; TransactionDefinition.TIMEOUT_DEFAULT) &#123;</div><div class="line">		throw new InvalidTimeoutException(&quot;Invalid transaction timeout&quot;, definition.getTimeout());</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	// No existing transaction found -&gt; check propagation behavior to find out how to proceed.</div><div class="line">	if (definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_MANDATORY) &#123;</div><div class="line">		throw new IllegalTransactionStateException(</div><div class="line">				&quot;No existing transaction found for transaction marked with propagation &apos;mandatory&apos;&quot;);</div><div class="line">	&#125;</div><div class="line">	else if (definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_REQUIRED ||</div><div class="line">			definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_REQUIRES_NEW ||</div><div class="line">			definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_NESTED) &#123;</div><div class="line">		SuspendedResourcesHolder suspendedResources = suspend(null);</div><div class="line">		if (debugEnabled) &#123;</div><div class="line">			logger.debug(&quot;Creating new transaction with name [&quot; + definition.getName() + &quot;]: &quot; + definition);</div><div class="line">		&#125;</div><div class="line">		try &#123;</div><div class="line">			boolean newSynchronization = (getTransactionSynchronization() != SYNCHRONIZATION_NEVER);</div><div class="line">			DefaultTransactionStatus status = newTransactionStatus(</div><div class="line">					definition, transaction, true, newSynchronization, debugEnabled, suspendedResources);</div><div class="line">			/*</div><div class="line">			 * 这里是创建事务的调用，由具体的事务处理器完成，比如：</div><div class="line">			 * HibernateTransactionManager和DataSourceTransactionManager</div><div class="line">			 */</div><div class="line">			doBegin(transaction, definition);</div><div class="line">			prepareSynchronization(status, definition);</div><div class="line">			return status;</div><div class="line">		&#125;</div><div class="line">		catch (RuntimeException ex) &#123;</div><div class="line">			resume(null, suspendedResources);</div><div class="line">			throw ex;</div><div class="line">		&#125;</div><div class="line">		catch (Error err) &#123;</div><div class="line">			resume(null, suspendedResources);</div><div class="line">			throw err;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	else &#123;</div><div class="line">		// Create &quot;empty&quot; transaction: no actual transaction, but potentially synchronization.</div><div class="line">		if (definition.getIsolationLevel() != TransactionDefinition.ISOLATION_DEFAULT &amp;&amp; logger.isWarnEnabled()) &#123;</div><div class="line">			logger.warn(&quot;Custom isolation level specified but no actual transaction initiated; &quot; +</div><div class="line">					&quot;isolation level will effectively be ignored: &quot; + definition);</div><div class="line">		&#125;</div><div class="line">		boolean newSynchronization = (getTransactionSynchronization() == SYNCHRONIZATION_ALWAYS);</div><div class="line">		return prepareTransactionStatus(definition, null, true, newSynchronization, debugEnabled, null);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">/**</div><div class="line"> * Create a TransactionStatus for an existing transaction.</div><div class="line"> */</div><div class="line">private TransactionStatus handleExistingTransaction(</div><div class="line">		TransactionDefinition definition, Object transaction, boolean debugEnabled)</div><div class="line">		throws TransactionException &#123;</div><div class="line"></div><div class="line">	if (definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_NEVER) &#123;</div><div class="line">		throw new IllegalTransactionStateException(</div><div class="line">				&quot;Existing transaction found for transaction marked with propagation &apos;never&apos;&quot;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	if (definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_NOT_SUPPORTED) &#123;</div><div class="line">		if (debugEnabled) &#123;</div><div class="line">			logger.debug(&quot;Suspending current transaction&quot;);</div><div class="line">		&#125;</div><div class="line">		Object suspendedResources = suspend(transaction);</div><div class="line">		boolean newSynchronization = (getTransactionSynchronization() == SYNCHRONIZATION_ALWAYS);</div><div class="line">		return prepareTransactionStatus(</div><div class="line">				definition, null, false, newSynchronization, debugEnabled, suspendedResources);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	if (definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_REQUIRES_NEW) &#123;</div><div class="line">		if (debugEnabled) &#123;</div><div class="line">			logger.debug(&quot;Suspending current transaction, creating new transaction with name [&quot; +</div><div class="line">					definition.getName() + &quot;]&quot;);</div><div class="line">		&#125;</div><div class="line">		SuspendedResourcesHolder suspendedResources = suspend(transaction);</div><div class="line">		try &#123;</div><div class="line">			boolean newSynchronization = (getTransactionSynchronization() != SYNCHRONIZATION_NEVER);</div><div class="line">			DefaultTransactionStatus status = newTransactionStatus(</div><div class="line">					definition, transaction, true, newSynchronization, debugEnabled, suspendedResources);</div><div class="line">			doBegin(transaction, definition);</div><div class="line">			prepareSynchronization(status, definition);</div><div class="line">			return status;</div><div class="line">		&#125;</div><div class="line">		catch (RuntimeException beginEx) &#123;</div><div class="line">			resumeAfterBeginException(transaction, suspendedResources, beginEx);</div><div class="line">			throw beginEx;</div><div class="line">		&#125;</div><div class="line">		catch (Error beginErr) &#123;</div><div class="line">			resumeAfterBeginException(transaction, suspendedResources, beginErr);</div><div class="line">			throw beginErr;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	if (definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_NESTED) &#123;</div><div class="line">		if (!isNestedTransactionAllowed()) &#123;</div><div class="line">			throw new NestedTransactionNotSupportedException(</div><div class="line">					&quot;Transaction manager does not allow nested transactions by default - &quot; +</div><div class="line">					&quot;specify &apos;nestedTransactionAllowed&apos; property with value &apos;true&apos;&quot;);</div><div class="line">		&#125;</div><div class="line">		if (debugEnabled) &#123;</div><div class="line">			logger.debug(&quot;Creating nested transaction with name [&quot; + definition.getName() + &quot;]&quot;);</div><div class="line">		&#125;</div><div class="line">		if (useSavepointForNestedTransaction()) &#123;</div><div class="line">			// Create savepoint within existing Spring-managed transaction,</div><div class="line">			// through the SavepointManager API implemented by TransactionStatus.</div><div class="line">			// Usually uses JDBC 3.0 savepoints. Never activates Spring synchronization.</div><div class="line">			DefaultTransactionStatus status =</div><div class="line">					prepareTransactionStatus(definition, transaction, false, false, debugEnabled, null);</div><div class="line">			status.createAndHoldSavepoint();</div><div class="line">			return status;</div><div class="line">		&#125;</div><div class="line">		else &#123;</div><div class="line">			// Nested transaction through nested begin and commit/rollback calls.</div><div class="line">			// Usually only for JTA: Spring synchronization might get activated here</div><div class="line">			// in case of a pre-existing JTA transaction.</div><div class="line">			boolean newSynchronization = (getTransactionSynchronization() != SYNCHRONIZATION_NEVER);</div><div class="line">			DefaultTransactionStatus status = newTransactionStatus(</div><div class="line">					definition, transaction, true, newSynchronization, debugEnabled, null);</div><div class="line">			doBegin(transaction, definition);</div><div class="line">			prepareSynchronization(status, definition);</div><div class="line">			return status;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	// Assumably PROPAGATION_SUPPORTS or PROPAGATION_REQUIRED.</div><div class="line">	if (debugEnabled) &#123;</div><div class="line">		logger.debug(&quot;Participating in existing transaction&quot;);</div><div class="line">	&#125;</div><div class="line">	if (isValidateExistingTransaction()) &#123;</div><div class="line">		if (definition.getIsolationLevel() != TransactionDefinition.ISOLATION_DEFAULT) &#123;</div><div class="line">			Integer currentIsolationLevel = TransactionSynchronizationManager.getCurrentTransactionIsolationLevel();</div><div class="line">			if (currentIsolationLevel == null || currentIsolationLevel != definition.getIsolationLevel()) &#123;</div><div class="line">				Constants isoConstants = DefaultTransactionDefinition.constants;</div><div class="line">				throw new IllegalTransactionStateException(&quot;Participating transaction with definition [&quot; +</div><div class="line">						definition + &quot;] specifies isolation level which is incompatible with existing transaction: &quot; +</div><div class="line">						(currentIsolationLevel != null ?</div><div class="line">								isoConstants.toCode(currentIsolationLevel, DefaultTransactionDefinition.PREFIX_ISOLATION) :</div><div class="line">								&quot;(unknown)&quot;));</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		if (!definition.isReadOnly()) &#123;</div><div class="line">			if (TransactionSynchronizationManager.isCurrentTransactionReadOnly()) &#123;</div><div class="line">				throw new IllegalTransactionStateException(&quot;Participating transaction with definition [&quot; +</div><div class="line">						definition + &quot;] is not marked as read-only but existing transaction is&quot;);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	boolean newSynchronization = (getTransactionSynchronization() != SYNCHRONIZATION_NEVER);</div><div class="line">	return prepareTransactionStatus(definition, transaction, false, newSynchronization, debugEnabled, null);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="具体事务处理器的实现"><a href="#具体事务处理器的实现" class="headerlink" title="具体事务处理器的实现"></a>具体事务处理器的实现</h2><p>下面，以DataSourceTransactionManager为例，简单介绍一下在具体的事务处理器中，是如何实现事务的创建、提交、<br>回滚这些底层的事务处理操作。在实现过程中，需要把数据库的Connection和当前的线程进行绑定。对于事务的提交<br>和回滚，都是直接调用Connection的提交和回滚方法来完成。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">public class DataSourceTransactionManager extends AbstractPlatformTransactionManager</div><div class="line">		implements ResourceTransactionManager, InitializingBean &#123;</div><div class="line"></div><div class="line">	private DataSource dataSource;</div><div class="line"></div><div class="line">	@Override</div><div class="line">	protected Object doGetTransaction() &#123;</div><div class="line">		DataSourceTransactionObject txObject = new DataSourceTransactionObject();</div><div class="line">		txObject.setSavepointAllowed(isNestedTransactionAllowed());</div><div class="line">		ConnectionHolder conHolder =</div><div class="line">				(ConnectionHolder) TransactionSynchronizationManager.getResource(this.dataSource);</div><div class="line">		txObject.setConnectionHolder(conHolder, false);</div><div class="line">		return txObject;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>TransactionSynchronizationManager保存了线程级别的变量，当处于同一个事务的方法调用doGetTransaction时，getResource方法返回的是同一个ConnectionHolder</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line">public abstract class TransactionSynchronizationManager &#123;</div><div class="line"></div><div class="line">	private static final Log logger = LogFactory.getLog(TransactionSynchronizationManager.class);</div><div class="line"></div><div class="line">	private static final ThreadLocal&lt;Map&lt;Object, Object&gt;&gt; resources =</div><div class="line">			new NamedThreadLocal&lt;Map&lt;Object, Object&gt;&gt;(&quot;Transactional resources&quot;);</div><div class="line">	/**</div><div class="line">	 * Retrieve a resource for the given key that is bound to the current thread.</div><div class="line">	 * @param key the key to check (usually the resource factory)</div><div class="line">	 * @return a value bound to the current thread (usually the active</div><div class="line">	 * resource object), or &#123;@code null&#125; if none</div><div class="line">	 * @see ResourceTransactionManager#getResourceFactory()</div><div class="line">	 */</div><div class="line">	public static Object getResource(Object key) &#123;</div><div class="line">		Object actualKey = TransactionSynchronizationUtils.unwrapResourceIfNecessary(key);</div><div class="line">		Object value = doGetResource(actualKey);</div><div class="line">		if (value != null &amp;&amp; logger.isTraceEnabled()) &#123;</div><div class="line">			logger.trace(&quot;Retrieved value [&quot; + value + &quot;] for key [&quot; + actualKey + &quot;] bound to thread [&quot; +</div><div class="line">					Thread.currentThread().getName() + &quot;]&quot;);</div><div class="line">		&#125;</div><div class="line">		return value;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	/**</div><div class="line">	 * Actually check the value of the resource that is bound for the given key.</div><div class="line">	 */</div><div class="line">	private static Object doGetResource(Object actualKey) &#123;</div><div class="line">		Map&lt;Object, Object&gt; map = resources.get();</div><div class="line">		if (map == null) &#123;</div><div class="line">			return null;</div><div class="line">		&#125;</div><div class="line">		Object value = map.get(actualKey);</div><div class="line">		// Transparently remove ResourceHolder that was marked as void...</div><div class="line">		if (value instanceof ResourceHolder &amp;&amp; ((ResourceHolder) value).isVoid()) &#123;</div><div class="line">			map.remove(actualKey);</div><div class="line">			// Remove entire ThreadLocal if empty...</div><div class="line">			if (map.isEmpty()) &#123;</div><div class="line">				resources.remove();</div><div class="line">			&#125;</div><div class="line">			value = null;</div><div class="line">		&#125;</div><div class="line">		return value;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

      
    </div>
      
      <footer>
        
  
  <div class="categories">
    <a href="/categories/TVDCR/">TVDCR</a>
  </div>

        
  
  <div class="tags">
    <a href="/tags/spring/">spring</a>, <a href="/tags/transacion/">transacion</a>, <a href="/tags/dynamic-reconfiguration/">dynamic reconfiguration</a>
  </div>

        
      
      <div class="clearfix"></div>
      </footer>
  </div>
</article>


<section id="comment">
  
</section>


</div></div>
    <aside id="sidebar" class="alignright">
  
<div class="widget tag">
  <h3 class="title">分类</h3>
  <ul class="entry">
  
    <li><a href="/categories/OpenStack/">OpenStack</a><small>3</small></li>
  
    <li><a href="/categories/TVDCR/">TVDCR</a><small>3</small></li>
  
    <li><a href="/categories/east/">east</a><small>2</small></li>
  
    <li><a href="/categories/nap/">nap</a><small>4</small></li>
  
    <li><a href="/categories/web/">web</a><small>4</small></li>
  
    <li><a href="/categories/书架/">书架</a><small>1</small></li>
  
    <li><a href="/categories/大数据/">大数据</a><small>1</small></li>
  
    <li><a href="/categories/未分类/">未分类</a><small>1</small></li>
  
  </ul>
</div>

</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2017 NAP Group
  
</div>
<div class="clearfix"></div></footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>



</body>
</html>

