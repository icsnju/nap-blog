<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>OpenStack平台Neutron服务初探 › NAP - Next Application Platform</title>
  <meta name="author" content="NAP Group">
  
  <meta name="description" content="之前搭建了一个两个结点的OpenStack集群，老板说太简单了太low了，于是最近又重新搭建了一个四个结点的OpenStack集群。其中包含一个Controller结点，一个Network结点和两个Compute结点。其中Network结点主要运行OpenStack中的网络服务，即Neutron组件。下面对这个集群的部署过程做一下总结，并且简单介绍一下Neutron服务。">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="OpenStack平台Neutron服务初探"/>
  <meta property="og:site_name" content="NAP - Next Application Platform"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="NAP - Next Application Platform" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  

</head>


<body>
  <header id="header"><div class="meta inner">
  <h1><a href="/">NAP - Next Application Platform</a></h1>
  <h2><a href="/"></a></h2>
  <nav id="main-nav">
    <ul>
      
      <li><a href="/archives">Archives</a></li>
      
    </ul>
    <div class="clearfix"></div>
  </nav>
</div>
<div class="clearfix"></div>
</header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
<div class="post-content">
  <header>
    
  
    <h1 class="title">OpenStack平台Neutron服务初探</h1>
  

    
      <time datetime="2015-12-01T16:00:00.000Z">2015-12-02</time>
    
  </header>
<div class="entry">
  
    <blockquote>
<p>之前搭建了一个两个结点的OpenStack集群，老板说太简单了太low了，于是最近又重新搭建了一个四个结点的OpenStack集群。其中包含一个Controller结点，一个Network结点和两个Compute结点。其中Network结点主要运行OpenStack中的网络服务，即Neutron组件。下面对这个集群的部署过程做一下总结，并且简单介绍一下Neutron服务。</p>
</blockquote>
<a id="more"></a>
<h2 id="扩展Compute结点"><a href="#扩展Compute结点" class="headerlink" title="扩展Compute结点"></a>扩展Compute结点</h2><p>扩展Compute结点相对来说是比较简单的。并且所有Computer节点的部署过程都是相同的，详细信息请参考上一篇。</p>
<h2 id="部署Network结点"><a href="#部署Network结点" class="headerlink" title="部署Network结点"></a>部署Network结点</h2><h3 id="开始之前"><a href="#开始之前" class="headerlink" title="开始之前"></a>开始之前</h3><p>在上一篇中，我们将Neutron服务的所有代理都放在了Controller组件里面，这些代理包括：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Linux网桥代理没建立layer-2虚拟网络，为实例提供VXLAN通道并处理安全组问题(security groups)。</div><div class="line">DHCP代理，用于在创建实例时分配IP地址。</div><div class="line">L3代理，为虚拟网络提供路由和NAT服务。</div><div class="line">Metadata代理，提供配置信息，如实例的证书等。</div></pre></td></tr></table></figure>
<p>我们想把上述代理都放在Network结点中，即将Neutron组件单独运行在一个结点中。我们的解决思路是尝试着分别将每个代理依次从Controller结点迁移到Network结点中。在此之前，我们首先将与各个代理相关的配置文件项列出来，并给予一些说明。</p>
<ul>
<li>ML2插件配置项(配置文件为/etc/neutron/plugins/ml2/ml2_conf.ini)</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">type_drivers = flat,vlan,vxlan</div><div class="line">tenant_network_types = vxlan</div><div class="line">mechanism_drivers = linuxbridge,l2population</div><div class="line">extension_drivers = port_security</div><div class="line">flat_networks = public</div><div class="line">vni_ranges = 1:1000</div><div class="line">enable_ipset = True</div></pre></td></tr></table></figure>
<p>在ml2插件的配置项中，主要是开启了flat,vlan,vxlan网络，其中私有网络(tenant)使用的是vxlan隧道，具体为下图所示。我们看到VXLAN隧道在网桥代理中，我们领management network的ip地址赋给VXLAN的网卡。而flat网络是OpenStack网络中的一种工作机制。Flat模式指定一个子网，规定虚拟机实例能使用的ip范围，也就是一个ip池，创建实例时，从ip池中取出一个有效的ip为虚拟机分配，并且在虚拟机启动时注入虚拟机镜像。在这里，给Flat网命名为public。</p>
<p><img src="/images/openstack-network-connect.png" alt=""></p>
<ul>
<li>Linux网桥代理配置</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">physical_interface_mappings = public:eth0 </div><div class="line">enable_vxlan = True </div><div class="line">local_ip = OVERLAY_INTERFACE_IP_ADDRESS</div><div class="line">l2_population = True</div><div class="line">prevent_arp_spoofing = True</div><div class="line">enable_security_group = True</div><div class="line">firewall_driver = neutron.agent.linux.iptables_firewall.IptablesFirewallDriver</div></pre></td></tr></table></figure>
<p>在Linux网桥的配置项中，我们开启了VXLAN通道，并且指定ip为management work中的ip，并将public网络绑定在eth0网卡(public network)。</p>
<ul>
<li>L3代理配置</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">interface_driver = neutron.agent.linux.interface.BridgeInterfaceDriver</div><div class="line">external_network_bridge =</div></pre></td></tr></table></figure>
<ul>
<li>DHCP代理配置</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">interface_driver = neutron.agent.linux.interface.BridgeInterfaceDriver</div><div class="line">dhcp_driver = neutron.agent.linux.dhcp.Dnsmasq</div><div class="line">enable_isolated_metadata = True</div></pre></td></tr></table></figure>
<p>在上述两个代理中，我们都在interface_driver项中选择了Linux网桥的驱动。</p>
<ul>
<li>Metadata代理配置，主要为与keystone和nova之间关于认证的一些<a href="http://docs.openstack.org/liberty/install-guide-ubuntu/neutron-controller-install.html" target="_blank" rel="external">配置项</a>，没有太多需要说明的。</li>
</ul>
<h3 id="将L3代理迁移到Network结点"><a href="#将L3代理迁移到Network结点" class="headerlink" title="将L3代理迁移到Network结点"></a>将L3代理迁移到Network结点</h3><ol>
<li>首先在Controller上面停掉L3代理，在Network结点上面启动L3代理，其实配置项都是一样的。</li>
<li>然后需要在Network结点配置好Linux网桥代理，原因不用说，只有L3代理不就相当于一个孤点么，没有任何作用。</li>
<li>重新建立一个网络，运行一个实例，配置一个floating-ip，然后ssh进去就可以啦！</li>
</ol>
<h3 id="将DHCP代理迁移到Network结点"><a href="#将DHCP代理迁移到Network结点" class="headerlink" title="将DHCP代理迁移到Network结点"></a>将DHCP代理迁移到Network结点</h3><ol>
<li>跟L3代理一样，首先还是在Network结点中启动DHCP代理，然后停掉Controller结点上面的DHCP代理。</li>
<li>本以为建立好一个网络后，一切还是很正常的运行，但是发现事实不是这样子的。当我写下这篇文章的时候，我只记得我当时去看了实例的log，发现已经分配了正确的ip地址，于是就断定DHCP代理是没有错的，并且查询了一下neutron的log，发现有几个是刚刚更新过的，发现在metadata的log里面，没有将请求或操作连接到正确的消息url中，即一直都在请求127.0.0.1的本地消息队列，而Network结点是没有装消息队列的，所以肯定是不对的。</li>
<li>最后，直接一次性将metadata代理也迁移了过去。</li>
<li>建立好一个网络，运行实例，配置一个floating-ip，然后ssh进去就可以啦！</li>
</ol>
<h3 id="结果截个图"><a href="#结果截个图" class="headerlink" title="结果截个图"></a>结果截个图</h3><ol>
<li><p>Neutron组件代理列表：<br> <img src="/images/openstack-neutron-agentlist.png" alt=""></p>
<p> 可以看到，Neutron组件的所有代理目前都跑在了Network结点上面。</p>
</li>
<li><p>Floating-ip测试：</p>
<p> 建立好一个虚拟机实例。<br> <img src="/images/openstack-neutron-novalist.png" alt=""></p>
<p> 然后ssh进去访问它。<br> <img src="/images/openstack-neutron-floatingip.png" alt=""></p>
<p> 可以看到我们最后是在Network结点上进行访问的，并且需要输入密码，这点我们会在后面详细解释一下。</p>
</li>
</ol>
<h2 id="在OpenStack中建立网络"><a href="#在OpenStack中建立网络" class="headerlink" title="在OpenStack中建立网络"></a>在OpenStack中建立网络</h2><p>之前说了那么多，下面具体讲一下在OpenStack中如何建立网络，看完这个过程，你会发现里面有一些东西会跟前面的某些名词对应上。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">source admin-openrc.sh</div><div class="line">neutron net-create public --shared --provider:physical_network public --provider:network_type flat</div></pre></td></tr></table></figure>
<p>这条命令会建立一个类型为flat，名称为public的共享虚拟网络。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">neutron subnet-create public 10.0.2.0/24 --name public --allocation-pool start=10.0.2.110,end=10.0.2.200 --dns-nameserver 10.0.2.3 --gateway 10.0.2.2</div></pre></td></tr></table></figure>
<p>这条命令会为public网络分配ip池，可以看到分配了90个ip，并且有相对应的dns服务器和网关。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">source demo-openrc.sh</div><div class="line">neutron net-create private</div><div class="line">neutron subnet-create private 172.16.1.0/24 --name private --dns-nameserver 10.0.2.3 --gateway 172.16.1.1</div></pre></td></tr></table></figure>
<p>这两条命令是demo用户创建了一个私有的虚拟网络，名字为private。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">source admin-openrc.sh</div><div class="line">neutron net-update public --router:external</div><div class="line">source demo-openrc.sh</div><div class="line">neutron router-create router</div><div class="line">neutron router-interface-add router private</div><div class="line">neutron router-gateway-set router public</div></pre></td></tr></table></figure>
<p>上述命令会建立一个路由器router，并且将private网络作为router上面的一个网卡，将public网络当做router上面的网关。建好了网络，在建立实例之前，首先验证一下。在Controller结点上面列出端口信息。并且查看每个端口的详细信息。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">source admin-openrc.sh</div><div class="line">neutron router-port-list router</div><div class="line">neutron port-show $(id)</div></pre></td></tr></table></figure>
<p>截图如下：<br><img src="/images/openstack-router-port-list.png" alt=""></p>
<p>可以看到这些端口绑定的host_id是neutron，即Network结点。这是因为L3代理是在Network结点上面的。这个时候检查一下网络的名空间，就应该在Network结点，而不是Controller结点了。</p>
<p><img src="/images/openstack-ip-netns.png" alt=""></p>
<p>并且这个router的网关10.0.2.112只能在Network结点上ping通。并且，建立好实例后，目前只能在Network结点ping通分配好的floating-ip，在ssh进去的时候是需要输入密码的，这是因为默认的ssh-key是controller结点上的。其实，按照官方文档的说法，只要在public网络下面的任何结点都是可以通过ssh的方式进入虚拟机实例的，而我们目前只能在Network结点上，这是因为我们新建的路由器是绑定在Network结点上面的，而这是因为L3代理是运行在Network结点上面的。感觉能够通过添加路由转发规则的方式，令public子网内所有的主机都能通过floating-ip访问虚拟机实例。这一点会在本文写好之后进行尝试。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>经过这两天的尝试，感觉OpenStack的灵活性很高。就像我们这一次把Neutron服务从Controller结点迁移到Network结点，都是直接把网络代理从这边关闭，到那边打开就可以。给我的感觉就像是传说中的那种可以在硬件层面上组装的手机，需要什么零件自己选择。</p>
<p>还有一点就是，在出现错误时，我目前都是看log的。log的目录是在/var/log/$(service)/*.log中，每次都查看最近更新过的log，然后看里面有什么错误之类的。</p>

  
</div>

  <footer>
  
  
  <div class="categories">
  类别： <a href="/categories/OpenStack/">OpenStack</a>
  </div>


  
  
  <div class="tags">
  Tags： <a href="/tags/OpenStack/">OpenStack</a>, <a href="/tags/Neutron/">Neutron</a>
  </div>


  
  <br />
  <hr />
  <br />
  
<nav id="article-nav">
  <div class="article-nav-title">
  
    <a style="color:black" href="/2015/12/zookeeper-note/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">新文章: </strong>
        
          ZooKeeper 学习笔记
        
    </a>
  
  
      <a style="float:right;color:black" href="/2015/11/openstack_floating_ip/" id="article-nav-older" class="article-nav-link-wrap">
        <strong class="article-nav-caption">旧文章: </strong>
        
          OpenStack平台手动搭建以及floating-ip的使用
        
      </a>
  
    </div>
</nav>


  

  <div class="clearfix"></div>
</footer>
</div>
</article>



</div></div>
    <aside id="sidebar" class="alignright">
  
<div class="widget tag">
  <h3 class="title">分类</h3>
  <ul class="entry">
  
    <li><a href="/categories/OpenStack/">OpenStack</a><small>3</small></li>
  
    <li><a href="/categories/TVDCR/">TVDCR</a><small>3</small></li>
  
    <li><a href="/categories/east/">east</a><small>2</small></li>
  
    <li><a href="/categories/misc/">misc</a><small>1</small></li>
  
    <li><a href="/categories/nap/">nap</a><small>4</small></li>
  
    <li><a href="/categories/web/">web</a><small>4</small></li>
  
    <li><a href="/categories/书架/">书架</a><small>1</small></li>
  
    <li><a href="/categories/大数据/">大数据</a><small>1</small></li>
  
    <li><a href="/categories/未分类/">未分类</a><small>1</small></li>
  
  </ul>
</div>


  
<div class="widget tag">
  <h3 class="title">固定链接</h3>
  <ul class="entry">
    
      <li>
        <a href="http://blog.nxap.org/2017/03/books/" title="我们的书架">我们的书架</a>
      </li>
    
      <li>
        <a href="http://blog.jetmuffin.com/" title="Jie CHEN">Jie CHEN</a>
      </li>
    
      <li>
        <a href="http://blog.leanote.com/1324480595@qq.com" title="Shuo CHEN">Shuo CHEN</a>
      </li>
    
      <li>
        <a href="https://nap-ghj.github.io/" title="Hongjun GE">Hongjun GE</a>
      </li>
    
      <li>
        <a href="https://itanch.github.io/" title="Tianchi LIU">Tianchi LIU</a>
      </li>
    
      <li>
        <a href="https://Luziling.github.io/" title="Ziling LU">Ziling LU</a>
      </li>
    
      <li>
        <a href="https://dmemoing.github.io/" title="Jing DENG">Jing DENG</a>
      </li>
    
      <li>
        <a href="https://rdmclin2.github.io/" title="Chenglin MENG">Chenglin MENG</a>
      </li>
    
      <li>
        <a href="https://co2y.github.io/" title="Weiyi WANG">Weiyi WANG</a>
      </li>
    
      <li>
        <a href="https://qunnn41.github.io/" title="Yiqun WANG">Yiqun WANG</a>
      </li>
    
      <li>
        <a href="https://flyxu.github.io/" title="Xiang XU">Xiang XU</a>
      </li>
    
      <li>
        <a href="https://njuywy.github.io/" title="Weiyu YE">Weiyu YE</a>
      </li>
    
      <li>
        <a href="https://monkey-h.github.io/" title="Zhongliang YUAN">Zhongliang YUAN</a>
      </li>
    
      <li>
        <a href="https://ying-zhang.github.io/" title="Ying ZHANG">Ying ZHANG</a>
      </li>
    
  </ul>
</div>


</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  <a href=http://blog.nxap.org>NAP - Next Application Platform</a> &nbsp;
  
  &copy; 2017 NAP Group
  
</div>
<div class="clearfix"></div>
</footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>



</body>
</html>

